<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Maestros y Alumnos API .NET</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input, button { padding: 8px; margin: 5px 0; display: block; width: 300px; }
        ul { margin-top: 10px; list-style-type: none; padding-left: 0; }
        .maestro { margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
        .eliminar-alumno, .eliminar-maestro { margin-left: 10px; padding: 4px 8px; cursor: pointer; }
        .busqueda { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>API .NET - Maestros y Alumnos</h1>

    <!-- FORMULARIO PARA AGREGAR MAESTRO O ALUMNO -->
    <input type="text" id="maestro" placeholder="Nombre del maestro (opcional para alumno suelto)" />
    <input type="text" id="alumno" placeholder="Nombre del alumno (opcional para maestro solo)" />
    <button onclick="agregarRegistro()">Agregar maestro/alumno</button>

    <div class="busqueda">
        <input type="text" id="busquedaMaestro" placeholder="Buscar por maestro" oninput="buscarMaestro()" />
        <div id="resultadoMaestro"></div>

        <input type="text" id="busquedaAlumno" placeholder="Buscar por alumno" oninput="buscarAlumno()" />
        <div id="resultadoAlumno"></div>
    </div>

    <h2>Maestros y sus alumnos:</h2>
    <div id="listaDatos"></div>

    <script>
        const apiUrl = "http://localhost:5000/api/maestros";
        let registrosGlobal = [];

        // AGREGAR maestro o alumno
        async function agregarRegistro() {
            const maestro = document.getElementById("maestro").value.trim();
            const alumno = document.getElementById("alumno").value.trim();

            if (!maestro && !alumno) {
                alert("Debes ingresar al menos un maestro o un alumno.");
                return;
            }

            try {
                if (maestro) {
                    // Enviar maestro (con o sin alumno)
                    const data = {
                        nombre: maestro,
                        alumnos: alumno ? [{ nombre: alumno }] : []
                    };

                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });
                    await response.json();
                }

                if (!maestro && alumno) {
                    // Enviar alumno suelto
                    const dataAlumno = { nombre: alumno };
                    const response = await fetch(apiUrl + "/alumno-suelto", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(dataAlumno)
                    });
                    await response.json();
                }

                document.getElementById("maestro").value = "";
                document.getElementById("alumno").value = "";
                obtenerDatos();

            } catch (err) {
                console.error("Error al agregar:", err);
                alert("Hubo un error al agregar el registro.");
            }
        }

        async function obtenerDatos() {
            const response = await fetch(apiUrl);
            const datos = await response.json();
            registrosGlobal = datos;

            const contenedor = document.getElementById("listaDatos");
            contenedor.innerHTML = "";

            datos.forEach(entry => {
                const div = document.createElement("div");
                div.className = "maestro";

                const titulo = document.createElement("strong");
                titulo.textContent = `Maestro: ${entry.nombre}`;
                div.appendChild(titulo);

                const lista = document.createElement("ul");
                if (entry.alumnos && Array.isArray(entry.alumnos)) {
                    entry.alumnos.forEach(alumno => {
                        const li = document.createElement("li");
                        li.textContent = alumno.nombre;

                        const btn = document.createElement("button");
                        btn.textContent = "Eliminar";
                        btn.className = "eliminar-alumno";
                        btn.onclick = () => eliminarAlumno(entry.nombre, alumno.nombre);

                        li.appendChild(btn);
                        lista.appendChild(li);
                    });
                }
                div.appendChild(lista);

                const btnMaestro = document.createElement("button");
                btnMaestro.textContent = "Eliminar maestro";
                btnMaestro.className = "eliminar-maestro";
                btnMaestro.onclick = () => eliminarMaestro(entry.nombre);

                div.appendChild(btnMaestro);
                contenedor.appendChild(div);
            });

            // Traer alumnos sueltos (sin maestro)
            const responseAlumnos = await fetch(apiUrl + "/buscar/alumno-suelto");
            if (responseAlumnos.ok) {
                const sueltos = await responseAlumnos.json();
                sueltos.forEach(a => {
                    const div = document.createElement("div");
                    div.className = "maestro";
                    div.innerHTML = `<strong>Alumno suelto:</strong> ${a.nombre} 
                        <button class="eliminar-alumno" onclick="eliminarAlumno('', '${a.nombre}')">Eliminar</button>`;
                    contenedor.appendChild(div);
                });
            }
        }

        async function eliminarMaestro(nombre) {
            if (!confirm(`¿Eliminar completamente al maestro "${nombre}"?`)) return;
            await fetch(apiUrl + "/maestro", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(nombre)
            });
            obtenerDatos();
        }

        async function eliminarAlumno(maestro, alumno) {
            if (!confirm(`¿Eliminar al alumno "${alumno}"?`)) return;

            const body = maestro ? { maestro, alumno } : { alumno };
            await fetch(apiUrl + "/alumno", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            obtenerDatos();
        }

        function buscarMaestro() {
            const nombre = document.getElementById("busquedaMaestro").value.toLowerCase();
            const resultado = document.getElementById("resultadoMaestro");
            resultado.innerHTML = "";

            const encontrado = registrosGlobal.find(r => r.nombre.toLowerCase().includes(nombre));
            if (encontrado) {
                resultado.innerHTML = `<p><strong>${encontrado.nombre}</strong> tiene ${encontrado.alumnos.length} alumno(s):</p><ul>` +
                    encontrado.alumnos.map(a => `<li>${a.nombre}</li>`).join('') +
                    '</ul>';
            } else if (nombre !== "") {
                resultado.innerHTML = `<p>No se encontró al maestro "${nombre}".</p>`;
            }
        }

        function buscarAlumno() {
            const nombre = document.getElementById("busquedaAlumno").value.toLowerCase();
            const resultado = document.getElementById("resultadoAlumno");
            resultado.innerHTML = "";

            let encontrado = null;
            registrosGlobal.forEach(r => {
                if (r.alumnos.some(a => a.nombre.toLowerCase().includes(nombre))) {
                    encontrado = r;
                }
            });

            if (encontrado) {
                resultado.innerHTML = `<p>El alumno pertenece al maestro <strong>${encontrado.nombre}</strong>.</p>`;
            } else if (nombre !== "") {
                resultado.innerHTML = `<p>No se encontró ningún maestro para el alumno "${nombre}".</p>`;
            }
        }

        obtenerDatos();
    </script>
</body>
</html>
